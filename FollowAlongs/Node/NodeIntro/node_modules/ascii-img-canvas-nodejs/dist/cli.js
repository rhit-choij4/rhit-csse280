#!/usr/bin/env node
"use strict";var validateArgs={block:Boolean,chars:String,height:Number,htmlColor:Boolean,invert:Boolean,opacity:Boolean,raw:Boolean,width:Number,writeFileWithTag:String};const fs=require("fs");var dir=new function(){this.scan=async function(t,r){if(""===t||"/"===t)return console.error("Error: directory to scan cannot be empty."),console.error('If you want to scan your script location, please use "dir2array.Scan(__dirname);"'),null;if("/"!==t.slice(-1)&&(t+="/"),!this.dirExists(t))return;const i=async t=>fs.readdirSync(t).sort().reduce(async(n,e)=>{await n;const s=t+e;return this.dirExists(s)?i(s+"/"):r(s)},Promise.resolve());return i(t)},this.dirExists=function(t){try{return fs.lstatSync(t).isDirectory()}catch(t){return!1}},this.fileExists=function(t){try{return fs.existsSync(t)}catch(t){return!1}}};const{createCanvas:createCanvas,loadImage:loadImage}=require("canvas");async function fromCanvas(t,r,i,n){const e=await loadImage(t),s=createCanvas(r,i);s.width=r,s.height=i;const a=s.getContext("2d");a.drawImage(e,0,0,r,i);const o=a.getImageData(0,0,r,i).data,c=[];let l;for(let t=0;t<i;t+=2)for(let i=0;i<r;i++){const e=4*(t*r+i),s=[o[e],o[e+1],o[e+2],o[e+3]];0===i&&(l=[],n?n(l):c.push(l)),n?n(s):l.push(s)}return c}const defaultCharList=" .,:;i1tfLCG08@",defaultColorCharList=" CGO08@",convertHtmlChars={" ":"&nbsp;"},rgbHtmlStr=(t,r,i)=>"rgb("+[t,r,i].join(",")+");";function toAscii({chars:t,isInvert:r,isHtmlColor:i,isBlock:n,isOpacity:e,isRaw:s}){let a=[];const o=(t||(i?defaultColorCharList:defaultCharList)).split("");function c(t){if(0===t.length){if(0===a.length)return;return void a.push(i?"<br/>":s?["",[]]:"\n")}const[c,l,u]=t,h=(.3*c+.59*l+.11*u)/255;let f=o.length-1-Math.round(h*(o.length-1));r&&(f=o.length-1-f);let d=o[f];i&&convertHtmlChars[d]&&(d=convertHtmlChars[d]);const g=function(t,[r,s,a,o]){if(!i)return;return"<span style='color:"+rgbHtmlStr(r,s,a)+(n?"background-color:"+rgbHtmlStr(r,s,a):"")+(e?"opacity:"+o/255+";":"")+"'>"+t+"</span>"}(d,t)||function(t,[r,i,n,e]){if(!s)return;return[t,[r,i,n,e]]}(d,t)||d;a.push(g)}function l(t){if(!Array.isArray(t))return s?JSON.stringify(a):a.join("");a=t}return{asciiChars:l,pixel:c,pixels:function(t){return t.forEach(t=>{t.forEach(t=>{c(t)}),c([])}),l()}}}const{promisify:promisify}=require("util"),{URL:URL}=require("url"),http=require("http"),https=require("https"),sizeOf=require("image-size");var dimensions=async t=>{if(dir.fileExists(t))return promisify(sizeOf)(t);const r=new URL(t);return new Promise(i=>{(t.startsWith("https:")?https:http).get(r,t=>{const r=[];t.on("data",t=>{r.push(t)}).on("end",()=>{const t=Buffer.concat(r);i(sizeOf(t))})})})};const defaultWidth=100;async function calcDimensions({width:t,height:r},i){if(t&&r)return{width:t,height:r};let n=t,e=r;const s=await dimensions(i);if(n||e||(n=defaultWidth),n){const t=s.width/n;e=Math.round(s.height/t)}else{const t=s.height/e;n=Math.round(s.width/t)}return{width:n,height:e}}async function asciiImgCanvasNodejs(t,r={}){if(!t||"string"!=typeof t)throw new TypeError("Invalid image source value: "+t);if("object"!=typeof r)throw new TypeError("Invalid options: "+r);const i=r.chars||null,n=!0===r.opacity,e=!0===r.block,s=!0===r.htmlColor,a=!0===r.invert,o=!0===r.raw,c=!1!==r.stream,{width:l,height:u}=await calcDimensions(r,t),h=toAscii({chars:i,isInvert:a,isBlock:e,isOpacity:n,isHtmlColor:s,isRaw:o});if(c)return await fromCanvas(t,l,u,h.pixel),h.asciiChars();const f=await fromCanvas(t,l,u);return h.pixels(f)}const fs$1=require("fs");function formatOutput(t,r){let i=[];return r&&i.push("FILENAME="+r+":"),i.push(t),r&&i.push("[EOF]"),i=i.join("\n")}async function main(){const t=process.argv.slice(2),[r,...i]=t;r||console.log("run: ascii-img {image-path} {options?}");const n=i.reduce((t,r)=>{const[i,n]=r.replace(/^--?/,"").split("=");return validateArgs[i]&&(t[i]=validateArgs[i](n)),t},{}),{writeFileWithTag:e}=n,s=async(t,r)=>{if(!r&&!t.match(/\.(jpe?g|png|svg)$/i))return;const i=formatOutput(await asciiImgCanvasNodejs(t,n).catch(console.log),e?void 0:t);e?fs$1.writeFileSync(`${t}.${e}`,i,"utf-8"):console.log(i)};dir.dirExists(r)?await dir.scan(r,s):s(r,!0)}main();
